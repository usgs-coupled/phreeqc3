cmake_minimum_required (VERSION 3.3)

set(TESTS
  alkalinity
  a_e_t2
  aj1
  all_llnl
  aquia
  aquia2
  As
  as.ex
  asf
  ball
  basic_test
  brown
  calc_SC
  calc_values
  cdmus3
  cdmusic_related
  cd_ddl
  cell_operations
  ch4-valid
  co2
  colloid_U
  comments
  count_database_species
  cumulativetime
  DanPhuong
  ddl_flux
  ddlsurf
  de
  deb1
  deb2
  debye1
  deltas
  desc
  dissolve_only
  donly
  dump_test
  eco
  eq_EC
  eq_phase_mod
  evap
  exch_related
  exch_related_pz
  exch_kin_related
  exch_kin_related_pz
  ex_ild
  ferri_surface
  fiona
  fixed_volume_gas
  fixed_volume_gas_pz
  fluorite
  gas
  Gas_FixVolume
  gas_mod
  gas_phase_pressure
  gfw
  hard.tests
  high_mu
  homo
  i2
  i3
  i4
  i5
  i6
  i7
  Ilulissat_diff3
  is
  include
  initial_gas
  Int_vs_Don
  iso_example
  iso10
  jgb2col
  jgbcol
  joe
  kin_time
  kinex
  kinsurf
  krest
  lam7
  lam10
  lassin
  llnl
  local_min_pz
  low_t
  mahoney
  MassWater
  membrane
  mgcl2mgso4_pz
  millero
  mixes
  mmb
  mmb2
  modifyact
  modify_test
  modify_zero
  mu
  n3
  netpathxl
  negexp_totmol
  np.test
  opa_col2
  org_gas
  oxygen
  p_dep_species
  phantom_surface
  phase_formula
  phreeqc.test
  phrqpitz.tst
  pitzalphas
  pitzer_fail
  pitzer_redef
  pitzgas
  precipitate_only
  pressure_si
  prob8
  pyrite_34s
  rahn
  reaction_p
  run_cells
  s1
  salt_ec
  salt_ec_chart
  samemodel
  saver
  saunders
  sit_redox
  solid_solution
  solid_solution_pz
  solution_s
  species_formula
  spread_solution
  sc1
  sc2
  sc3
  sc4
  sc5
  sc6
  sc6a
  sc6b
  sc7
  stag_diss_only
  surf3
  surf_check
  surf3_density
  surf_related
  surf_related_pz
  surf_kin_related
  surf_kin_related_pz
  surf_related_warnings
  surf_transport
  surface_punch_all
  ss_r
  sys_ex
  sys_gas
  t2
  t922
  test_sit
  transport
  transport.dl
  trim
  user_print
  using
  volume-zero
  y_H2O
  zn.test
  zero_modify
  ex1
  ex2
  ex3
  ex4
  ex5
  ex6
  ex7
  ex8
  ex8_tail_biter
  ex9
  ex10
  ex10_pz
  ex11
  ex12
  ex20_debug
  ex6.cvode
  ex9.cvode
  ex15.cvode
  colt1
  colt2
  colt3
  colt3_mi
  colt4
  colt5
  minteq
  minteqv4
  ex16mp
  ex17mp
  ex18mp
  feb
  febmp
  katz
  np.testmp
  oxygenmp
  spread_redox
  raw
  ppdump
  diel
  H_K
  Sat_P_rho
  densities
  CH4_conc_PR_IS
  CO2_anal
  CO2_conc_PR_EQ
  CO2_conc_PR_GP
  CO2_conc_PR_IS
  CO2_K_H
  CO2_4M_NaCl
  CO2_Na2SO4
  co2_t30
  co2_tc
  fix_P
  fix_V
  gas_fix_P
  gas_fix_V
  gypsum_P
  gypsum_P2
  N2_conc_PR_IS
  N2_ideal
  NaCl
  O2_conc_PR_IS
  P_CO2_Na2SO4
  P_Vm
  phi_Angus
  phi_Duan_PR
  phi_Duan_PR_EQ
  PR_EQ
  PR_EQ_GP
  PR_equil
  PR_equil2
  PR_initial_gas
  PR_initial_gas_noredox
  PR_mx_new
  ternary
  water_vp1
  Barite_MCl2
  Barite_NaCl
  Barite_tc
  cc_P
  cc_P0
  cc_P2
  cc_P3
  evap_sea
  halite
  seaw_anhyd
  SrSO4_P
  SrSO4_tc
  water_vp
  Apelbl_Na2CO3
  mV_SO4_rho
  mV1_rho
  mV2_rho
  pKw
  Vm_BaCl2_sol
  Vm_CaCl2_sol
  Vm_HCl_sol
  Vm_KCl_sol
  Vm_KHCO3_sol
  Vm_MgCl2_sol
  Vm_Na2CO3_sol
  Vm_Na2SO4_sol
  Vm_NaCl_sol
  Vm_NaHCO3_sol
  Vm_NaNO3_sol
  Vm_NH4Cl_sol
  Vm_SrCl2_sol
  rho_CaNaCl
  rho_CaKMgNaCl
  co2_VP
  phi_CO2-CH4_GP
  rho_MgCaCl
  rho_MgNaCl
  Vm_salt
  Vm_salt_65
  Vm_salt_fig
  Vm0_tc
  Carnallite
  K2SO4
  KCl
  KCl-SO4
  MgCl2
  MgCl-SO4
  MgSO4
  Na2SO4
  Na2SO4_phr
  NaCl_temp
  NaCl-SO4
  NaKCl
  NaMgCl
  14C_isotopes
  str_f
  anhy_K2SO4
  anhy_Na2SO4
  anhy_NaCl
  gyps_NaCl
  gyps_Na2SO4
  gypsum
  gas9
  Halite_P
  anh_P_NaCl
  gypsum_P5
  multi_punch
  rho_H3PO4
  soln_vol
  Vm_LiCl_sol
  negative_user_number
  run_cell_range
  punch_stream
  modify_ignore
  connect_graph
  variable_cell_diffusion
  no_negative_dump
  reaction_pressure_gas
  pitzer_redef_2
  KinSorbNp
  lkspecies
  Nardi
  jm_trans
  andsurfcomplex4
  diff_c
  cc_1barCO2
  surf_total
  peng_SO2
  num_spread
  sys_equi
  toner
  lk_phase
  calcite_rate
  CFAscmtest
  sar
  CO2_sp_IS
  Hebach
  erm
  co2_pressure_bug
  edl_species
  R-04_01_PHRC
  McBride_rho
  Ca-As-Mahoney
  missing_surf_related_equi
  missing_surf_related_kin
  SC_temp
  feedwater
  current1
  uphill_NP
  SC_Ohm
  adapted_minteq
  sys_kin
  harm_mean
  unequal
  Syn1_acidbase
  phase_vm
  low_p
  calc_density
  Ratework
  salt_sc
  IL_flux
  SC_Ohm1
  salt_sc1
  McClesk
  stuyfz
  opa_col3
  sys_equi_fix
  pr_h2o
  ex7_T_P
  antarcticite
  DonnanBug
  IllitisationCEC
  PercentSC
  ExchangeGamma
  count_database_species_core10
  dist_x
  balonis
  mmb2_pitzer
  ddl_set
  rotter
  gas_type_switch
  CalPortDiff
  ss_incr
  gas_phase_mix
  iso_inverse
  TonyLitharge2a
  implicit_as
  surface_mix
  andra_kin_ss
  ex12b
  ex13_impl
  Cub
  ExchMixRelatedMin
  ExchMixRelatedKin
  SurfMixRelatedMin
  SurfMixRelatedKin
  MoreExchMix
  notab
  zeta
  sys_sort
  kinetic_rates
  delta_h
  uphill_NPa
)

# these take more than 1000 seconds
set(SKIP
  adapted_minteq
  count_database_species
  current2
  current_analytical
  membrane
  mmb2
  unequal
)

# expected fails
set(FAILS
  high_mu
  modify_test
  negexp_totmol
  pitzer_fail
  surf_related_warnings
  raw
  negative_user_number
  punch_stream
  CFAscmtest
  missing_surf_related_equi
  missing_surf_related_kin
  feedwater
  Syn1_acidbase
  IllitisationCEC
)

# mytest misc files
set(mytest_MISC
  angus.dat
  anh_nacl.csv
  anh_P_100tc.csv
  anh_P_150tc.csv
  anh_P_200tc.csv
  Apelbl_Na2CO3.dat
  Barite_NaCl.dat
  Barite_tc.dat
  Carnallite.csv
  casf_na.csv
  cc_1barCO2.dat
  cc_p_CO2.dat
  cc_P.dat
  cc_tc100.dat
  ch4_25c.dat
  ch4_50c.dat
  ch4_100c.dat
  co2_4m_NaCl.dat
  CO2_Na2SO4.dat
  co2_t30.dat
  co2_tc.dat
  co2_VP.dat
  co2.dat
  co2.dat
  co2.dat
  co2.dat
  Cub_export.txt
  Cub_Jdsb_export.txt
  Cub_JdsbSr.txt
  Cub_Sr.txt
  dens.csv
  densities.dat
  eco.dat
  eq_phase_mod.dat
  ex15.dat
  f_CO2_50.dat
  f_CO2_50.dat
  f_CO2_75.dat
  f_CO2.dat
  f_CO2.dat
  gas_no_redox.dat
  gyps_Na2SO4.csv
  gyps_NaCl.csv
  H_K.tsv
  halite.dat
  Hebach.dat
  include2
  include3
  include4
  jm_trans.dat
  kinetic_rates.dat
  LangmuirAs_wateq4f.dat
  mahoney.dat
  McBride_rho.tsv
  McBride_rho2.tsv
  McBride_rho3.tsv
  mgso4.csv
  mV_SO4_rho.dat
  mV1_rho.dat
  mV2_rho.dat
  n2_25C.dat
  na2so4.csv
  nakcl.csv
  Nardi.dat
  O2_27.dat
  p_CO2_Na2SO4.dat
  Pabalan.dat
  pfw.dat
  Phmaster14.dat
  Phreeqc_master_NEA_Ra_Mo_V_MCJ.dat
  pitzer-04.dat
  Qin_CH4.dat
  Qin_CO2.dat
  sar.dat
  srso4_P.dat
  THEREDA_PIT_PHRC_r04.dat
  Tipping&Hurley.dat
  Vm0_tc.dat
  y_H2O.dat
  zeta.tsv
)

# for mytest tests
foreach(misc ${mytest_MISC})
  configure_file(${misc} ${misc} COPYONLY)
endforeach()

# add tests
foreach(test ${TESTS})
  if (NOT ${test} IN_LIST SKIP)
    add_test(NAME mytest.${test}
             COMMAND $<TARGET_FILE:phreeqc> ${PROJECT_SOURCE_DIR}/mytest/${test} ${test}.out xxx ${test}.log
    )
    if (${test} IN_LIST FAILS)
      set_tests_properties(mytest.${test} PROPERTIES WILL_FAIL TRUE)
    endif()
  endif()
endforeach()

# numdiff tests
set(REL_ERROR 1e-3)

find_program(NUMDIFF_COMMAND NAMES numdiff)

if (NUMDIFF_COMMAND)
  file(GLOB NUMDIFFS
    RELATIVE ${CMAKE_CURRENT_LIST_DIR}
    *_101.sel
  )
  foreach(numdiff ${NUMDIFFS})
    configure_file(${numdiff} ${numdiff}.expected)
    string(REGEX REPLACE "_101.sel" "" prefix ${numdiff})
    add_test(NAME mytest.numdiff.${prefix}
      COMMAND ${NUMDIFF_COMMAND} --relative-tolerance=${REL_ERROR} ${numdiff} ${numdiff}.expected
    )
  endforeach()
endif()
